name: build docker image and deploy

on:
  push:
    # 以下路径/文件才会触发，关于路径条件官方文档https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#onpushpull_requestpaths
    paths:
      - '.github/**'
      - 'src/**'
      - 'Dockerfile'
      - '.dockerignore'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码到本地
        uses: actions/checkout@v2
      
      - name: 设置 QEMU
        uses: docker/setup-qemu-action@v1

      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: 设置环境变量
        env:
          # docker 私库地址
          DOCKER_REGISTRY_URL: registry.cn-shenzhen.aliyuncs.com
          # 容器名称
          CONTAINER_NAME: wechat-bot
          # docker run 命令的部分参数 远程服务器run已经写了 name 参数和镜像
          DOCKER_RUN_PARAMS: -p 4300:4300
        run: |
          fullCommit="${{ github.event.commits[0].id }}"
          # 定义变量 以 commit id前7位做版本标识（因为github commit 页面只展示前7位，这里一样方便搜索）
          IMAGE_TAG="${DOCKER_REGISTRY_URL}/iamc/wechat-bot:${fullCommit:0:7}"
          echo $IMAGE_TAG
          # 写入 IMAGE_TAG 到 GITHUB_ENV 环境文件，变成环境变量，后面的流程可以使用 命令语法 https://docs.github.com/cn/actions/reference/workflow-commands-for-github-actions#setting-an-environment-variable
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: 登录docker镜像私库
        run: |
          docker login $DOCKER_REGISTRY_URL -u ${{secrets.DOCKER_USERNAME}} -p ${{secrets.DOCKER_PASSWORD}}
      #   uses: docker/login-action@v1
      #   with:
      #     registry: ${{env.DOCKER_REGISTRY_URL}}
      #     username: ${{secrets.DOCKER_USERNAME}}
      #     password: ${{secrets.DOCKER_PASSWORD}}

      # - name: 构建并推送
      #   uses: docker/build-push-action@v2
      #   with:
      #     platforms: linux/amd64,linux/arm/v7,linux/arm64
      #     tags: ${{env.IMAGE_TAG}}
      #     push: true
        
      # - name: 通知服务器更新部署
      #   uses: JimCronqvist/action-ssh@master
      #   with:
      #       hosts: ${{ secrets.SERVICE_HOSTS }}
      #       privateKey: ${{ secrets.SERVICE_PRIVATE_KEY }}
      #       debug: false
      #       command: |
      #         /root/update_docker.sh $DOCKER_REGISTRY_URL $DOCKER_USERNAME $DOCKER_PASSWORD $IMAGE_TAG $CONTAINER_NAME $DOCKER_RUN_PARAMS